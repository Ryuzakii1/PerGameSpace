{% extends "base.html" %}

{% block content %}
<h2>Edit Game: {{ game.title }}</h2>
<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="title">Game Title:</label>
        <input type="text" id="title" name="title" value="{{ game.title }}" required>
    </div>

    <div class="form-group">
        <label for="system">System:</label>
        <select id="system" name="system">
            {% for sys in systems %}
                <option value="{{ sys.name }}" {% if sys.name == game.system %}selected{% endif %}>{{ sys.name }}</option>
            {% endfor %}
            <option value="">-- Select or Add New --</option>
        </select>
        <label for="new_system_name" class="label-inline">Or Add New System:</label>
        <input type="text" id="new_system_name" name="new_system_name" placeholder="e.g., PS2, Nintendo Switch">
    </div>

    <div class="form-group">
        <label for="game_file">Replace Game File (Optional):</label>
        <input type="file" id="game_file" name="game_file">
        <p class="file-info">Current file: {{ game.filepath.split('/')[-1].split('\\')[-1] }}</p>
    </div>

    <div class="form-group">
        <label for="cover_file">Replace Custom Cover Image (Optional):</label>
        <input type="file" id="cover_file" name="cover_file" accept="image/*">
        {% if game.cover_url %}
            <p class="file-info">Current cover:</p>
            <img src="{{ game.cover_url }}" alt="Current Cover" class="current-cover-preview">
            <label class="checkbox-label">
                <input type="checkbox" name="clear_cover" value="true"> Clear current cover
            </label>
        {% else %}
            <p class="file-info">No current cover.</p>
        {% endif %}
    </div>

    <fieldset class="form-fieldset">
        <legend>Or Find New Cover on IGDB</legend>
        <div class="form-group">
            <label for="igdb_search_query">Search Game Title on IGDB:</label>
            <input type="text" id="igdb_search_query" name="igdb_search_query" placeholder="e.g., The Legend of Zelda: Ocarina of Time">
            <button type="button" onclick="searchIgdb()">Search IGDB</button>
        </div>
        <div id="igdb_results" class="game-grid" style="margin-top: 15px;">
            </div>
        <input type="hidden" id="igdb_cover_url" name="igdb_cover_url">
    </fieldset>

    <button type="submit" class="button primary">Update Game</button>
    <a href="{{ url_for('library.game_detail', game_id=game.id) }}" class="button secondary">Cancel</a>
</form>

<script>
    async function searchIgdb() {
        const query = document.getElementById('igdb_search_query').value;
        const resultsDiv = document.getElementById('igdb_results');
        resultsDiv.innerHTML = '<p>Searching...</p>';
        document.getElementById('igdb_cover_url').value = ''; // Clear previous selection

        if (!query) {
            resultsDiv.innerHTML = '<p>Please enter a search query.</p>';
            return;
        }

        try {
            // Updated URL to point to the blueprint
            const response = await fetch("{{ url_for('igdb.igdb_search') }}?query=" + encodeURIComponent(query));
            const games = await response.json();

            if (games.length === 0) {
                resultsDiv.innerHTML = '<p>No results found on IGDB.</p>';
                return;
            }

            resultsDiv.innerHTML = '';
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card'; // Reuse your game-card style
                gameCard.innerHTML = `
                    <img src="${game.cover_url || '{{ url_for("static", filename="placeholder.png") }}'}" alt="Cover" style="cursor:pointer;" onclick="selectIgdbCover('${game.cover_url}')">
                    <h3>${game.name}</h3>
                    <p>${game.platforms} (${game.release_date})</p>
                `;
                resultsDiv.appendChild(gameCard);
            });

            if (games.length > 0) {
                resultsDiv.innerHTML += '<p style="text-align: center; margin-top: 10px;">Click a cover to select it.</p>';
            }

        } catch (error) {
            console.error('Error searching IGDB:', error);
            resultsDiv.innerHTML = '<p>Error searching IGDB. Check console for details.</p>';
        }
    }

    function selectIgdbCover(coverUrl) {
        document.getElementById('igdb_cover_url').value = coverUrl;
        alert('IGDB cover selected! It will be downloaded when you submit the form.');
        // You could add a visual indicator here, e.g., highlight the selected cover.
    }
</script>
{% endblock %}