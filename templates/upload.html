{% extends "base.html" %}

{% block content %}
<h2>Upload New Game</h2>
<form method="POST" enctype="multipart/form-data">
    
    <fieldset class="form-fieldset">
        <legend>File Information</legend>
        <div class="form-group">
            <label for="game_file">Game File:</label>
            <input type="file" id="game_file" name="game_file" required>
        </div>
    </fieldset>

    <fieldset class="form-fieldset">
        <legend>Game Metadata</legend>
        <div class="form-group">
            <label for="title">Game Title:</label>
            <input type="text" id="title" name="title" required>
        </div>
        
        <div class="form-group">
            <label for="system">System:</label>
            <select id="system" name="system">
                {% for sys in systems %}
                    <option value="{{ sys.name }}">{{ sys.name }}</option>
                {% endfor %}
                <option value="">-- Select or Add New --</option>
            </select>
        </div>

        <a href="#" id="metadata-toggle" class="metadata-toggle-link" onclick="toggleMetadata(event)">Expand &gt;</a>
        
        <div id="additional-metadata-fields" style="display: none;">
            
            <div class="form-group">
                <label for="igdb_search_query_metadata" class="label-inline">Find on IGDB:</label>
                <input type="text" id="igdb_search_query_metadata" name="igdb_search_query_metadata" placeholder="Search title for metadata">
                <button type="button" onclick="searchIgdbMetadata()">Get Metadata</button>
            </div>
            
            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="15" style="font-size: 1.1em; width: 100%;" placeholder="Game description..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="genre">Genre:</label>
                <input type="text" id="genre" name="genre" placeholder="e.g., Action, RPG, Platform">
            </div>

            <div class="form-group">
                <label for="release_year">Release Year:</label>
                <input type="number" id="release_year" name="release_year" placeholder="e.g., 1996" min="1970" max="2030">
            </div>

            <div class="form-group">
                <label for="developer">Developer:</label>
                <input type="text" id="developer" name="developer" placeholder="e.g., Nintendo">
            </div>

            <div class="form-group">
                <label for="publisher">Publisher:</label>
                <input type="text" id="publisher" name="publisher" placeholder="e.g., Nintendo">
            </div>

            <div class="form-group">
                <label for="play_status">Play Status:</label>
                <select id="play_status" name="play_status">
                    <option value="Not Played">Not Played</option>
                    <option value="Playing">Currently Playing</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Dropped">Dropped</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="new_system_name" class="label-inline">Or Add New System:</label>
                <input type="text" id="new_system_name" name="new_system_name" placeholder="e.g., PS2, Nintendo Switch">
            </div>
        </div>
    </fieldset>

    <fieldset class="form-fieldset">
        <legend>Cover Art</legend>
        <div class="form-group">
            <p class="file-info">Upload a custom cover image or search on IGDB.</p>
            <label for="cover_file">Upload Custom Cover Image (Optional):</label>
            <input type="file" id="cover_file" name="cover_file" accept="image/*">
        </div>

        <div class="form-group">
            <label for="igdb_search_query_cover">Find New Cover on IGDB:</label>
            <input type="text" id="igdb_search_query_cover" name="igdb_search_query_cover" placeholder="Search title for cover">
            <button type="button" onclick="searchIgdbCovers()">Search for Cover</button>
        </div>
        <div id="igdb_results" class="game-grid" style="margin-top: 15px;"></div>
        <input type="hidden" id="igdb_cover_image_id" name="igdb_cover_image_id">
    </fieldset>

    <button type="submit" class="button primary">Upload Game</button>
    <a href="{{ url_for('navigation.library') }}" class="button secondary">Cancel</a>
</form>

<style>
.form-fieldset {
    margin-bottom: 25px;
}
.metadata-toggle-link {
    cursor: pointer;
    font-size: 0.9em;
    font-weight: normal;
    text-decoration: none;
    color: #007bff;
    display: block;
    margin-top: 10px;
}
.selected-igdb-cover {
    border: 3px solid #007bff !important;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5) !important;
}

.game-card {
    position: relative;
    cursor: pointer;
    transition: transform 0.2s;
}

.game-card:hover {
    transform: scale(1.05);
}

.igdb-select-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
}

.game-card:hover .igdb-select-overlay {
    opacity: 1;
}

.current-cover-preview {
    border: 1px solid #ddd;
    border-radius: 4px;
    margin: 10px 0;
}
</style>

<script>
function toggleMetadata(event) {
    event.preventDefault();
    const metadataFields = document.getElementById('additional-metadata-fields');
    const toggleLink = document.getElementById('metadata-toggle');
    if (metadataFields.style.display === 'none') {
        metadataFields.style.display = 'block';
        toggleLink.innerHTML = 'Collapse &lt;';
    } else {
        metadataFields.style.display = 'none';
        toggleLink.innerHTML = 'Expand &gt;';
    }
}

function cleanFilename(filename) {
    let title = filename.split('.').slice(0, -1).join('.');
    title = title.replace(/[\(\[].*?[\)\]]/g, '').trim();
    title = title.replace(/_/g, ' ').replace(/\./g, ' ');
    title = title.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    return title;
}

document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM content loaded. Attaching event listener to file input.");
    const fileInput = document.getElementById('game_file');
    const titleInput = document.getElementById('title');
    const igdbMetadataQueryInput = document.getElementById('igdb_search_query_metadata');
    const igdbCoverQueryInput = document.getElementById('igdb_search_query_cover');
    
    if (fileInput && titleInput) {
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const filename = fileInput.files[0].name;
                const suggestedTitle = cleanFilename(filename);
                console.log(`File selected: ${filename}`);
                console.log(`Suggested title: ${suggestedTitle}`);
                
                titleInput.value = suggestedTitle;
                
                // Also automatically populate the IGDB search queries
                igdbMetadataQueryInput.value = suggestedTitle;
                igdbCoverQueryInput.value = suggestedTitle;
            }
        });
    } else {
        console.error("Could not find file input or title input elements.");
    }
});


async function searchIgdb(mode) {
    const metadataQuery = document.getElementById('igdb_search_query_metadata').value;
    const coverQuery = document.getElementById('igdb_search_query_cover').value;
    const query = mode === 'metadata' ? metadataQuery : coverQuery;
    
    const system = document.getElementById('system').value || 'Other';
    const resultsDiv = document.getElementById('igdb_results');
    
    if (mode === 'covers') {
        resultsDiv.innerHTML = '<p>Searching IGDB...</p>';
        document.getElementById('igdb_cover_image_id').value = '';
    }

    if (!query) {
        if (mode === 'covers') {
            resultsDiv.innerHTML = '<p>Please enter a search query.</p>';
        }
        return;
    }

    try {
        const url = "{{ url_for('igdb.igdb_search') }}?" + new URLSearchParams({
            query: query,
            system: system
        });
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const games = await response.json();

        if (games.error) {
            if (mode === 'covers') {
                resultsDiv.innerHTML = `<p>Error: ${games.error}</p>`;
            }
            return;
        }

        if (!games || games.length === 0) {
            if (mode === 'covers') {
                resultsDiv.innerHTML = '<p>No results found on IGDB.</p>';
            }
            return;
        }

        if (mode === 'metadata') {
            const bestMatch = games[0];
            if (bestMatch && bestMatch.full_metadata) {
                const metadata = bestMatch.full_metadata;
                document.getElementById('title').value = bestMatch.name;
                if (metadata.genre) document.getElementById('genre').value = metadata.genre;
                if (metadata.release_year) document.getElementById('release_year').value = metadata.release_year;
                if (metadata.developer) document.getElementById('developer').value = metadata.developer;
                if (metadata.publisher) document.getElementById('publisher').value = metadata.publisher;
                if (metadata.description) document.getElementById('description').value = metadata.description;
                flashMessage('Metadata imported successfully!', 'success');
            } else {
                flashMessage('No metadata found for this game.', 'warning');
            }
            return;
        }

        resultsDiv.innerHTML = '';
        games.forEach((game, index) => {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            gameCard.innerHTML = `
                <img src="${game.cover_url || '{{ url_for("static", filename="placeholder.png") }}'}" 
                     alt="Cover" 
                     style="width: 150px; height: 200px; object-fit: cover; cursor: pointer;" 
                     onclick="selectIgdbCover('${game.image_id}', ${index})">
                <div class="igdb-select-overlay">Click to select</div>
                <h3 style="margin: 10px 0 5px 0; font-size: 14px;">${game.name}</h3>
                <p style="margin: 0; font-size: 12px; color: #666;">${game.platforms} (${game.release_date})</p>
            `;
            gameCard.setAttribute('data-game-data', JSON.stringify(game));
            resultsDiv.appendChild(gameCard);
        });

        if (games.length > 0) {
            resultsDiv.innerHTML += '<p style="text-align: center; margin-top: 15px; font-style: italic;">Click a cover to select it for upload.</p>';
        }

    } catch (error) {
        console.error('Error searching IGDB:', error);
        if (mode === 'covers') {
            resultsDiv.innerHTML = `<p>Error searching IGDB: ${error.message}</p>`;
        }
    }
}

function searchIgdbMetadata() {
    searchIgdb('metadata');
}

function searchIgdbCovers() {
    searchIgdb('covers');
}

function selectIgdbCover(imageId, gameIndex) {
    document.querySelectorAll('#igdb_results .game-card img').forEach(img => {
        img.classList.remove('selected-igdb-cover');
    });
    
    const selectedImg = document.querySelector(`#igdb_results .game-card:nth-child(${gameIndex + 1}) img`);
    selectedImg.classList.add('selected-igdb-cover');
    
    document.getElementById('igdb_cover_image_id').value = imageId || '';
    
    const overlay = selectedImg.parentElement.querySelector('.igdb-select-overlay');
    const originalText = overlay.textContent;
    overlay.textContent = 'Selected!';
    overlay.style.opacity = '1';
    
    setTimeout(() => {
        overlay.textContent = originalText;
        overlay.style.opacity = '0';
    }, 2000);
}

function flashMessage(message, category) {
    // This is a dummy function. Your notifications.js will handle the actual display.
    console.log(`Flash message: [${category}] ${message}`);
}
</script>
{% endblock %}