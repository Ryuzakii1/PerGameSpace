{% extends "base.html" %}

{% block title %}Playing {{ game.title }}{% endblock title %}

{% block styles %}
    {{ super() }}
    {# Link to the new dedicated CSS file for the emulator page #}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/emulator.css') }}">
{% endblock styles %}

{# Override the header and footer blocks from base.html to create an immersive, focused view #}
{% block header %}{% endblock header %}
{% block footer %}{% endblock footer %}

{% block content %}
<div class="emulator-container">
    
    {# --- Emulator Screen --- #}
    <div id="emulator-screen" class="emulator-screen">
        <canvas id="snes-canvas"></canvas> 
        <div id="loading-overlay" class="loading-overlay">
            <div class="loader"></div>
            <p id="loading-message">Click to start the game</p>
            <p id="loading-sub-message"></p>
        </div>
    </div>

    {# --- Game Title --- #}
    <div class="game-title-bar">
        <h2>Playing: {{ game.title }} ({{ game.system }})</h2>
        <div id="statusMessage" class="status-message"></div>
    </div>

    {# --- Control Buttons --- #}
    <div class="controls-grid">
        <button id="playPauseButton" class="button">Pause</button>
        <button id="resetButton" class="button">Reset</button>
        <button id="saveStateButton" class="button">Save State</button>
        <button id="loadStateButton" class="button">Load State</button>
        <button id="fullscreenButton" class="button">Fullscreen</button>
        <button id="settingsButton" class="button secondary">Settings</button>
        <a href="{{ url_for('library.game_detail', game_id=game.id) }}" class="button secondary">Exit</a>
    </div>
</div>

{# --- Settings Panel (Hidden by default) --- #}
<div id="settingsPanel" class="settings-panel">
    <div class="settings-panel-header">
        <h2>Emulator Settings</h2>
        <button id="closeSettingsPanel" class="close-button">&times;</button>
    </div>
    <div class="settings-panel-body">
        <h3>Key Bindings</h3>
        <div id="keyBindingsList" class="key-bindings-grid">
            {# Key binding elements will be populated here by JavaScript #}
        </div>
        <div class="settings-panel-actions">
            <button id="resetBindingsButton" class="button secondary">Reset to Defaults</button>
            <button id="saveBindingsButton" class="button primary">Save Settings</button>
        </div>
    </div>
</div>

{# Hidden div to pass game data from Flask to JavaScript #}
<div id="game-data-encoded" data-encoded-details="{{ encoded_game_details | safe }}" style="display: none;"></div>
{% endblock content %}

{% block scripts %}
    {# We don't call super() here because the base notifications.js is not needed on this page #}
    <script type="module" src="{{ url_for('static', filename='js/emulator.js') }}"></script>
{% endblock scripts %}
