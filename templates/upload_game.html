{% extends "base.html" %}

{% block content %}
<h2>Upload New Game</h2>
<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="title">Game Title:</label>
        <input type="text" id="title" name="title" required>
    </div>

    <div class="form-group">
        <label for="system">System:</label>
        <select id="system" name="system">
            {% for sys in systems %}
                <option value="{{ sys.name }}">{{ sys.name }}</option>
            {% endfor %}
            <option value="">-- Select or Add New --</option>
        </select>
        <label for="new_system_name" class="label-inline">Or Add New System:</label>
        <input type="text" id="new_system_name" name="new_system_name" placeholder="e.g., PS2, Nintendo Switch">
    </div>

    <div class="form-group">
        <label for="game_file">Game File:</label>
        <input type="file" id="game_file" name="game_file" required>
    </div>

    <div class="form-group">
        <label for="cover_file">Upload Custom Cover Image (Optional):</label>
        <input type="file" id="cover_file" name="cover_file" accept="image/*">
    </div>

    <fieldset class="form-fieldset">
        <legend>Or Find Cover on IGDB</legend>
        <div class="form-group">
            <label for="igdb_search_query">Search Game Title on IGDB:</label>
            <input type="text" id="igdb_search_query" name="igdb_search_query" placeholder="e.g., The Legend of Zelda: Ocarina of Time">
            <button type="button" onclick="searchIgdb()">Search IGDB</button>
        </div>
        <div id="igdb_results" class="game-grid" style="margin-top: 15px;">
            </div>
        <input type="hidden" id="igdb_cover_url" name="igdb_cover_url">
    </fieldset>

    <button type="submit" class="button primary">Upload Game</button>
</form>

<script>
    async function searchIgdb() {
        const query = document.getElementById('igdb_search_query').value;
        const resultsDiv = document.getElementById('igdb_results');
        resultsDiv.innerHTML = '<p>Searching...</p>';
        document.getElementById('igdb_cover_url').value = ''; // Clear previous selection

        if (!query) {
            resultsDiv.innerHTML = '<p>Please enter a search query.</p>';
            return;
        }

        try {
            const response = await fetch("{{ url_for('igdb.igdb_search') }}?query=" + encodeURIComponent(query));
            const games = await response.json();

            if (games.length === 0) {
                resultsDiv.innerHTML = '<p>No results found on IGDB.</p>';
                return;
            }

            resultsDiv.innerHTML = '';
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'game-card'; // Reuse your game-card style
                // Add a data-cover-url attribute to easily find the selected image later
                gameCard.innerHTML = `
                    <img src="${game.cover_url || '{{ url_for("static", filename="placeholder.png") }}'}" 
                         alt="Cover" 
                         style="cursor:pointer;" 
                         onclick="selectIgdbCover(this, '${game.cover_url}')">
                    <h3>${game.name}</h3>
                    <p>${game.platforms} (${game.release_date})</p>
                `;
                resultsDiv.appendChild(gameCard);
            });

            if (games.length > 0) {
                resultsDiv.innerHTML += '<p style="text-align: center; margin-top: 10px;">Click a cover to select it.</p>';
            }

        } catch (error) {
            console.error('Error searching IGDB:', error);
            resultsDiv.innerHTML = '<p>Error searching IGDB. Check console for details.</p>';
        }
    }

    // Modified to accept the clicked image element and the cover URL
    function selectIgdbCover(clickedImage, coverUrl) {
        document.getElementById('igdb_cover_url').value = coverUrl;

        // 1. Remove highlight from all other images
        document.querySelectorAll('#igdb_results .game-card img').forEach(img => {
            img.classList.remove('selected-igdb-cover');
        });

        // 2. Add highlight to the clicked image
        clickedImage.classList.add('selected-igdb-cover');
    }
</script>
{% endblock %}