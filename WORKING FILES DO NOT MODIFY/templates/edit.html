{% extends "base.html" %}

{% block content %}
    <div class="form-container">
        <h1>Edit Game: {{ game.title }}</h1>
        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" value="{{ game.title }}" required>
            </div>

            <div class="form-group">
                <label for="system">System:</label>
                <select id="system" name="system" required>
                    {% for sys in systems %}
                        <option value="{{ sys }}" {% if game.system == sys %}selected{% endif %}>{{ sys }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="8">{{ game.description if game.description else '' }}</textarea>
            </div>

            <hr> {# Separator for cover art options #}

            <div class="form-group">
                <label for="cover_file">Upload Custom Cover Art:</label>
                <input type="file" id="cover_file" name="cover_file" accept="image/*">
                {% if game.cover_url and game.cover_url.startswith('/static/covers/') %}
                    <p class="current-cover-note">Current: Custom Upload</p>
                    <img src="{{ game.cover_url }}" alt="Current Custom Cover" class="cover-preview">
                {% endif %}
            </div>

            <div class="form-group">
                <label for="cover_url">Or provide a Cover Art URL:</label>
                <input type="text" id="cover_url" name="cover_url" value="{{ display_cover_url if display_cover_url else '' }}">
                <button type="button" id="clear_cover_btn" class="btn btn-secondary btn-small">Clear Cover</button>
                {# Hidden input to signal if the user explicitly cleared the URL field #}
                <input type="hidden" id="cover_url_cleared" name="cover_url_cleared" value="false">
                {% if game.cover_url and not game.cover_url.startswith('/static/covers/') %}
                    <p class="current-cover-note">Current: External URL</p>
                    <img src="{{ game.cover_url }}" alt="Current External Cover" class="cover-preview">
                {% endif %}
            </div>

            <div class="form-group checkbox-group">
                {# IMPORTANT: id and name are 'auto_metadata_toggle' #}
                <input type="checkbox" id="auto_metadata_toggle" name="auto_metadata_toggle">
                <label for="auto_metadata_toggle">Automatically find metadata (cover art & description)</label>
            </div>

            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Get references to the elements
    const autoMetadataToggle = document.getElementById('auto_metadata_toggle'); // Changed variable name for clarity
    const coverUrlInput = document.getElementById('cover_url');
    const coverFileInput = document.getElementById('cover_file');
    const clearCoverBtn = document.getElementById('clear_cover_btn');
    const coverUrlClearedInput = document.getElementById('cover_url_cleared');

    // Function to update the state of the cover input fields
    function updateCoverInputStates() {
        if (autoMetadataToggle.checked) {
            // When auto-find is checked, disable manual inputs and clear their values
            coverUrlInput.disabled = true;
            coverUrlInput.value = ''; // Clear text input so it doesn't override auto
            coverFileInput.disabled = true;
            if (clearCoverBtn) clearCoverBtn.disabled = true;
            // Ensure the 'clear' signal is false if auto is trying to find
            if (coverUrlClearedInput) coverUrlClearedInput.value = 'false'; 
        } else {
            // When auto-find is unchecked, enable manual inputs
            coverUrlInput.disabled = false;
            coverFileInput.disabled = false;
            if (clearCoverBtn) clearCoverBtn.disabled = false;
            // Restore the original URL if it was an external one, otherwise keep empty
            const currentDisplayCoverUrl = "{{ display_cover_url }}";
            if (currentDisplayCoverUrl) {
                coverUrlInput.value = currentDisplayCoverUrl;
            }
        }
    }

    // Set initial state when the page loads
    updateCoverInputStates();

    // Add event listener for the auto-metadata toggle
    autoMetadataToggle.addEventListener('change', updateCoverInputStates);

    // Event listener for the Clear Cover button
    if (clearCoverBtn) {
        clearCoverBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the current cover art?')) {
                coverUrlInput.value = ''; // Clear the URL text input
                if (coverFileInput) {
                    coverFileInput.value = ''; // Clear the selected file in the file input
                }
                if (coverUrlClearedInput) {
                    coverUrlClearedInput.value = 'true'; // Signal to Flask that the URL was cleared
                }
                // Also uncheck the auto-metadata toggle if the user manually clears
                autoMetadataToggle.checked = false;
                updateCoverInputStates(); // Update states based on new toggle status

                // Optional: Update displayed cover to placeholder immediately
                const imgElement = document.querySelector('.cover-preview'); // Assuming .cover-preview is on the img
                if (imgElement) {
                    imgElement.src = "{{ url_for('static', filename='images/placeholder.png') }}";
                }
            }
        });
    }

</script>
{% endblock %}